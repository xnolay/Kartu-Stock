<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Kartu Stok Fisik Barang - PT. GMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, query, writeBatch, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // GANTI BAGIAN DI BAWAH INI DENGAN KONFIGURASI DARI PROYEK FIREBASE ANDA
        const firebaseConfig = {
          apiKey: "AIzaSyBN6dL5426rxsTg9uMWh7TY7CsUUoMShtc", // Ganti dengan milik Anda
          authDomain: "aplikasi-kas-gms.firebaseapp.com", // Ganti dengan milik Anda
          projectId: "aplikasi-kas-gms", // Ganti dengan milik Anda
          storageBucket: "aplikasi-kas-gms.appspot.com", // Ganti dengan milik Anda
          messagingSenderId: "114489294414", // Ganti dengan milik Anda
          appId: "1:114489294414:web:12c579bd0748d462180d1f" // Ganti dengan milik Anda
        };
        // ------------------------------------------------------------------------------------------

        // --- DOM ELEMENTS & CONFIG CHECK ---
        const configErrorEl = document.getElementById('config-error');
        const authForms = document.getElementById('auth-forms');
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("MASUKKAN")) {
             if(configErrorEl && authForms) {
                authForms.classList.add('hidden');
                configErrorEl.innerHTML = `<h3 class="text-xl font-semibold mb-4 text-center text-red-600">Konfigurasi Dibutuhkan</h3><p class="text-center text-gray-700">Anda perlu memasukkan konfigurasi Firebase Anda ke dalam file HTML ini agar aplikasi dapat berjalan.</p>`;
                configErrorEl.classList.remove('hidden');
            }
            throw new Error("Firebase configuration is missing.");
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- GLOBAL APP STATE ---
        let allTransactions = []; let stockChart; let userId = null; let currentTransactionId = null;
        let dbTransactionPath = ''; let dbSettingsPath = ''; let dbItemMasterPath = '';
        let unsubscribe = null; let itemSettings = {}; let itemMasterData = {};
        
        // --- DOM ELEMENTS ---
        const authView = document.getElementById('auth-view'); const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form'); const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error'); const showRegisterBtn = document.getElementById('show-register-btn');
        const showLoginBtn = document.getElementById('show-login-btn'); const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const itemSearchInput = document.getElementById('item-search-input');
        const searchResultsContainer = document.getElementById('search-results-container');
        const mainItemSelector = document.getElementById('main-item-selector');
        const initialStockInput = document.getElementById('initial-stock-input');
        const saveInitialStockBtn = document.getElementById('save-initial-stock-btn');
        const saveStatusEl = document.getElementById('save-status');
        const cardSaldoAwal = document.getElementById('card-saldo-awal'); const cardTotalMasuk = document.getElementById('card-total-masuk');
        const cardTotalKeluar = document.getElementById('card-total-keluar'); const cardSaldoAkhir = document.getElementById('card-saldo-akhir');
        const transactionForm = document.getElementById('transaction-form'); const transactionTableBody = document.getElementById('transaction-table-body');
        const printHistoryBtn = document.getElementById('print-history-btn'); const printSummaryBtn = document.getElementById('print-summary-btn');
        const manageItemsBtn = document.getElementById('manage-items-btn'); const importModal = document.getElementById('import-modal');
        const importForm = document.getElementById('import-form'); const importTextarea = document.getElementById('import-textarea');
        const importStatus = document.getElementById('import-status'); const cancelImportBtn = document.getElementById('cancel-import-btn');
        const editModal = document.getElementById('edit-modal'); const deleteModal = document.getElementById('delete-modal');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                userEmailDisplay.textContent = user.email;
                dbTransactionPath = `/artifacts/${firebaseConfig.appId}/users/${userId}/stock_transactions`;
                dbSettingsPath = `/artifacts/${firebaseConfig.appId}/users/${userId}/stock_settings`;
                dbItemMasterPath = `/artifacts/${firebaseConfig.appId}/public/data/item_master`;
                authView.classList.add('hidden'); appView.classList.remove('hidden');
                if (user.email === 'xnolay@gmail.com') { manageItemsBtn.parentElement.classList.remove('hidden'); } 
                else { manageItemsBtn.parentElement.classList.add('hidden'); }
                loadInitialData();
            } else {
                if (unsubscribe) unsubscribe(); userId = null; 
                manageItemsBtn.parentElement.classList.add('hidden');
                authView.classList.remove('hidden'); appView.classList.add('hidden');
            }
        });

        const handleRegister = (e) => { e.preventDefault(); const email = registerForm.email.value; const password = registerForm.password.value; authError.textContent = ''; createUserWithEmailAndPassword(auth, email, password).then(cred => registerForm.reset()).catch(err => authError.textContent = getFriendlyAuthError(err.code)); };
        const handleLogin = (e) => { e.preventDefault(); const email = loginForm.email.value; const password = loginForm.password.value; authError.textContent = ''; signInWithEmailAndPassword(auth, email, password).then(cred => loginForm.reset()).catch(err => authError.textContent = getFriendlyAuthError(err.code)); };
        const handleLogout = () => signOut(auth);
        function getFriendlyAuthError(c){switch(c){case'auth/invalid-email':return'Format email tidak valid.';case'auth/user-not-found':case'auth/wrong-password':case'auth/invalid-credential':return'Email atau password salah.';case'auth/email-already-in-use':return'Email ini sudah terdaftar.';case'auth/weak-password':return'Password terlalu lemah (min. 6 karakter).';default:return'Terjadi kesalahan.';}}

        // --- DATA HANDLING ---
        async function loadInitialData() {
            await loadItemMaster();
            const settingsDocRef = doc(db, dbSettingsPath, 'items');
            const settingsSnap = await getDoc(settingsDocRef);
            if (settingsSnap.exists()) itemSettings = settingsSnap.data();
            listenToTransactions();
        }
        
        async function loadItemMaster() {
            try {
                const querySnapshot = await getDocs(collection(db, dbItemMasterPath));
                itemMasterData = {};
                querySnapshot.forEach((doc) => { itemMasterData[doc.id] = doc.data().items || []; });
                populateItemDropdowns(); // Still populate for fallback and data source
            } catch (error) { console.error("Error loading item master:", error); alert("Gagal memuat daftar barang. Pastikan aturan Firebase sudah diperbarui."); }
        }

        function populateItemDropdowns() {
            const itemSelectors = [document.getElementById('main-item-selector'), document.getElementById('form-item-name'), document.querySelector('#edit-form select[name="itemName"]')];
            itemSelectors.forEach(selector => {
                selector.innerHTML = '<option value="">-- Pilih Nama Barang --</option>';
                const sortedCategories = Object.keys(itemMasterData).sort();
                for (const category of sortedCategories) {
                    const optgroup = document.createElement('optgroup'); optgroup.label = category;
                    itemMasterData[category].forEach(item => { const option = document.createElement('option'); option.value = item; option.textContent = item; optgroup.appendChild(option); });
                    selector.appendChild(optgroup);
                }
            });
        }
        
        function handleSearchInput() {
            const keyword = itemSearchInput.value.toLowerCase();
            searchResultsContainer.innerHTML = '';
            if (keyword.length < 2) {
                searchResultsContainer.classList.add('hidden');
                return;
            }

            const allItems = Object.values(itemMasterData).flat();
            const matchedItems = allItems.filter(item => item.toLowerCase().includes(keyword)).slice(0, 10); // Limit results

            if (matchedItems.length > 0) {
                matchedItems.forEach(item => {
                    const resultEl = document.createElement('div');
                    resultEl.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                    resultEl.textContent = item;
                    resultEl.addEventListener('click', () => selectItemFromSearch(item));
                    searchResultsContainer.appendChild(resultEl);
                });
                searchResultsContainer.classList.remove('hidden');
            } else {
                searchResultsContainer.classList.add('hidden');
            }
        }
        
        function selectItemFromSearch(itemName) {
            mainItemSelector.value = itemName;
            document.getElementById('form-item-name').value = itemName;
            itemSearchInput.value = '';
            searchResultsContainer.classList.add('hidden');
            updateDisplay();
        }

        function listenToTransactions() {
            if (unsubscribe) unsubscribe();
            const q = query(collection(db, dbTransactionPath));
            unsubscribe = onSnapshot(q, (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDisplay();
            });
        }

        async function saveInitialStock() {
            const selectedItem = mainItemSelector.value; if (!selectedItem) return;
            const newInitialStock = parseInt(initialStockInput.value, 10) || 0;
            saveStatusEl.textContent = 'Menyimpan...';
            try {
                await setDoc(doc(db, dbSettingsPath, 'items'), { [selectedItem]: newInitialStock }, { merge: true });
                itemSettings[selectedItem] = newInitialStock;
                updateDisplay();
                saveStatusEl.textContent = 'Tersimpan!';
                setTimeout(() => { saveStatusEl.textContent = ''; }, 2000);
            } catch (error) { saveStatusEl.textContent = 'Gagal menyimpan.'; }
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const newTransaction = { date: form.date.value, itemName: form.itemName.value, invoice: form.invoice.value, customerName: form.customerName.value.trim(), description: form.description.value.trim(), type: form.type.value, quantity: parseInt(form.quantity.value, 10), createdAt: new Date().toISOString() };
            if (!newTransaction.itemName || !newTransaction.date || !newTransaction.quantity) { alert("Tanggal, Nama Barang, dan Jumlah harus diisi."); return; }
            try {
                await addDoc(collection(db, dbTransactionPath), newTransaction);
                form.reset(); form.date.valueAsDate = new Date(); form.itemName.value = mainItemSelector.value;
            } catch (error) { alert("Gagal menyimpan transaksi."); }
        }

        // --- UI UPDATE & DISPLAY ---
        function updateDisplay() {
            const selectedItem = mainItemSelector.value;
            document.getElementById('form-item-name').value = selectedItem;
            if (!selectedItem) {
                cardSaldoAwal.textContent = '-'; cardTotalMasuk.textContent = '-'; cardTotalKeluar.textContent = '-'; cardSaldoAkhir.textContent = '-';
                transactionTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-6">Pilih barang untuk melihat riwayat stok.</td></tr>';
                if(stockChart) stockChart.destroy(); return;
            }
            const saldoAwal = itemSettings[selectedItem] || 0;
            const transactionsForItem = allTransactions.filter(t => t.itemName === selectedItem).sort((a, b) => new Date(a.date) - new Date(b.date));
            let totalMasuk = 0, totalKeluar = 0, runningBalance = saldoAwal;
            transactionTableBody.innerHTML = '';
            transactionsForItem.forEach(t => {
                if (t.type === 'masuk') { totalMasuk += t.quantity; runningBalance += t.quantity; } else { totalKeluar += t.quantity; runningBalance -= t.quantity; }
                const row = document.createElement('tr'); row.className = 'bg-white border-b';
                row.innerHTML = `<td class="py-4 px-6">${new Date(t.date).toLocaleDateString('id-ID')}</td><td class="py-4 px-6">${t.invoice || '-'}</td><td class="py-4 px-6">${t.customerName || '-'}</td><td class="py-4 px-6">${t.description || '-'}</td><td class="py-4 px-6 text-green-600">${t.type === 'masuk' ? t.quantity : '-'}</td><td class="py-4 px-6 text-red-600">${t.type === 'keluar' ? t.quantity : '-'}</td><td class="py-4 px-6 font-medium">${runningBalance}</td><td class="py-4 px-6 text-center"><button data-id="${t.id}" class="edit-btn text-blue-600 p-1">✏️</button><button data-id="${t.id}" class="delete-btn text-red-600 p-1">🗑️</button></td>`;
                transactionTableBody.appendChild(row);
            });
            const rows = Array.from(transactionTableBody.querySelectorAll('tr')).reverse();
            transactionTableBody.innerHTML = '';
            rows.forEach(row => transactionTableBody.appendChild(row));
            cardSaldoAwal.textContent = saldoAwal; cardTotalMasuk.textContent = totalMasuk; cardTotalKeluar.textContent = totalKeluar;
            cardSaldoAkhir.textContent = saldoAwal + totalMasuk - totalKeluar;
            initialStockInput.value = saldoAwal;
            updateChart(transactionsForItem, saldoAwal);
        }
        function updateChart(data, saldoAwal) {
            const ctx = document.getElementById('stock-chart').getContext('2d'); if (stockChart) stockChart.destroy();
            let runningBalance = saldoAwal;
            const chartData = data.map(t => { runningBalance += (t.type === 'masuk' ? t.quantity : -t.quantity); return { x: new Date(t.date).getTime(), y: runningBalance }; });
            stockChart = new Chart(ctx, { type: 'line', data: { datasets: [{ label: 'Stok Fisik', data: chartData, borderColor: '#3B82F6', fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true } } } });
        }
        
        // --- MODALS (EDIT, DELETE, IMPORT) ---
        function openEditModal(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId); if (!transaction) return;
            currentTransactionId = transactionId; const form = document.getElementById('edit-form');
            form.date.value = transaction.date; form.itemName.value = transaction.itemName;
            form.invoice.value = transaction.invoice || ''; form.customerName.value = transaction.customerName || '';
            form.description.value = transaction.description || ''; form.type.value = transaction.type;
            form.quantity.value = transaction.quantity; editModal.classList.remove('hidden');
        }
        function closeEditModal() { editModal.classList.add('hidden'); currentTransactionId = null; }
        async function handleEditFormSubmit(e) {
            e.preventDefault(); if (!currentTransactionId) return;
            const form = e.target;
            const updatedData = { date: form.date.value, itemName: form.itemName.value, invoice: form.invoice.value, customerName: form.customerName.value.trim(), description: form.description.value.trim(), type: form.type.value, quantity: parseInt(form.quantity.value, 10) };
            try { await updateDoc(doc(db, dbTransactionPath, currentTransactionId), updatedData); closeEditModal(); } 
            catch (error) { alert("Gagal memperbarui transaksi."); }
        }
        function openDeleteModal(transactionId) { currentTransactionId = transactionId; deleteModal.classList.remove('hidden'); }
        function closeDeleteModal() { deleteModal.classList.add('hidden'); currentTransactionId = null; }
        async function handleDeleteConfirmed() {
            if (!currentTransactionId) return;
            try { await deleteDoc(doc(db, dbTransactionPath, currentTransactionId)); closeDeleteModal(); }
            catch (error) { alert("Gagal menghapus transaksi."); }
        }
        async function handleImportData(e) {
            e.preventDefault();
            const text = importTextarea.value; if (!text.trim()) { alert("Kotak teks kosong."); return; }
            importStatus.textContent = 'Mengimpor data...'; const categories = {};
            const lines = text.trim().split('\n');
            for (const line of lines) {
                const parts = line.split('\t');
                if (parts.length >= 2) {
                    const category = parts[0].trim(); const itemName = parts[1].trim();
                    if (category && itemName) { if (!categories[category]) categories[category] = []; categories[category].push(itemName); }
                }
            }
            if (Object.keys(categories).length === 0) { alert("Format data tidak valid. Pastikan Anda menyalin 2 kolom dari Excel (Kategori dan Nama Barang)."); importStatus.textContent = ''; return; }
            try {
                const batch = writeBatch(db);
                for (const categoryName in categories) { const docRef = doc(db, dbItemMasterPath, categoryName); batch.set(docRef, { items: categories[categoryName] }); }
                await batch.commit();
                importStatus.textContent = 'Berhasil! Daftar barang telah diperbarui.';
                await loadItemMaster();
                setTimeout(() => { importModal.classList.add('hidden'); importForm.reset(); importStatus.textContent = ''; }, 2000);
            } catch (error) { importStatus.textContent = 'Gagal mengimpor. Cek koneksi dan aturan Firebase.'; console.error("Import error:", error); }
        }

        // --- PDF EXPORT ---
        function generateItemHistoryPDF() {
            const selectedItem = mainItemSelector.value; if (!selectedItem) { alert("Pilih barang terlebih dahulu."); return; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const saldoAwal = itemSettings[selectedItem] || 0;
            const transactionsForItem = allTransactions.filter(t => t.itemName === selectedItem).sort((a, b) => new Date(a.date) - new Date(b.date));
            let runningBalance = saldoAwal;
            const head = [['Tanggal', 'Invoice/SJ', 'Customer', 'Keterangan', 'Masuk', 'Keluar', 'Saldo']];
            const body = [];
            body.push([ { content: 'Saldo Awal', colSpan: 6, styles: { fontStyle: 'bold' } }, { content: saldoAwal, styles: { halign: 'right', fontStyle: 'bold' } } ]);
            transactionsForItem.forEach(t => {
                const masuk = t.type === 'masuk' ? t.quantity : ''; const keluar = t.type === 'keluar' ? t.quantity : '';
                runningBalance += (t.type === 'masuk' ? t.quantity : -t.quantity);
                body.push([ new Date(t.date).toLocaleDateString('id-ID'), t.invoice || '', t.customerName || '', t.description || '', { content: masuk, styles: { halign: 'right' } }, { content: keluar, styles: { halign: 'right' } }, { content: runningBalance, styles: { halign: 'right' } } ]);
            });
            body.push([ { content: 'Saldo Akhir', colSpan: 6, styles: { fontStyle: 'bold' } }, { content: runningBalance, styles: { halign: 'right', fontStyle: 'bold' } } ]);
            doc.setFontSize(16); doc.text('Laporan Kartu Stok Fisik Barang', 14, 20); doc.setFontSize(12); doc.text(`Nama Barang: ${selectedItem}`, 14, 28);
            doc.autoTable({ head, body, startY: 35, theme: 'grid' }); doc.save(`kartu-stok-${selectedItem.replace(/ /g, '_')}.pdf`);
        }
        function generateStockSummaryPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const allItemNames = Object.values(itemMasterData).flat();
            const stockSummary = [];
            allItemNames.forEach(itemName => {
                const saldoAwal = itemSettings[itemName] || 0;
                const totalMasuk = allTransactions.filter(t => t.itemName === itemName && t.type === 'masuk').reduce((sum, t) => sum + t.quantity, 0);
                const totalKeluar = allTransactions.filter(t => t.itemName === itemName && t.type === 'keluar').reduce((sum, t) => sum + t.quantity, 0);
                const saldoAkhir = saldoAwal + totalMasuk - totalKeluar;
                if (saldoAkhir > 0) stockSummary.push({ name: itemName, stock: saldoAkhir });
            });
            stockSummary.sort((a, b) => a.name.localeCompare(b.name));
            const head = [['Nama Barang', 'Sisa Stok Akhir']];
            const body = stockSummary.map(item => [ item.name, { content: item.stock, styles: { halign: 'right' } } ]);
            doc.setFontSize(16); doc.text('Laporan Sisa Stok Semua Barang', 14, 20);
            doc.setFontSize(11); doc.text(`Per tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 28);
            doc.autoTable({ head, body, startY: 35, theme: 'grid' }); doc.save('laporan-sisa-stok.pdf');
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            showRegisterBtn.addEventListener('click', () => { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
            showLoginBtn.addEventListener('click', () => { registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
            mainItemSelector.addEventListener('change', updateDisplay);
            itemSearchInput.addEventListener('input', handleSearchInput);
            saveInitialStockBtn.addEventListener('click', saveInitialStock);
            transactionForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('edit-form').addEventListener('submit', handleEditFormSubmit);
            document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', handleDeleteConfirmed);
            document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteModal);
            printHistoryBtn.addEventListener('click', generateItemHistoryPDF);
            printSummaryBtn.addEventListener('click', generateStockSummaryPDF);
            manageItemsBtn.addEventListener('click', () => importModal.classList.remove('hidden'));
            cancelImportBtn.addEventListener('click', () => importModal.classList.add('hidden'));
            importForm.addEventListener('submit', handleImportData);
            transactionTableBody.addEventListener('click', (e) => {
                if(e.target.closest('.edit-btn')) openEditModal(e.target.closest('.edit-btn').dataset.id);
                if(e.target.closest('.delete-btn')) openDeleteModal(e.target.closest('.delete-btn').dataset.id);
            });
             document.addEventListener('click', (e) => {
                if (!searchResultsContainer.contains(e.target) && e.target !== itemSearchInput) {
                    searchResultsContainer.classList.add('hidden');
                }
            });
        });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8F7F4; color: #333; }
        .card { background-color: #FFFFFF; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { border-radius: 0.5rem; padding: 0.625rem 1.25rem; font-weight: 500; transition: all 0.2s ease-in-out; border: 1px solid transparent; cursor: pointer; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
        .btn-primary { background-color: #3B82F6; color: white; } .btn-primary:hover { background-color: #2563EB; }
        .btn-secondary { background-color: #E5E7EB; color: #374151; border-color: #D1D5DB; } .btn-secondary:hover { background-color: #D1D5DB; }
        .btn-danger { background-color: #EF4444; color: white; } .btn-danger:hover { background-color: #DC2626; }
        .form-input, .form-select { border-radius: 0.5rem; border: 1px solid #D1D5DB; padding: 0.5rem 0.75rem; width: 100%; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3B82F6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .chart-container { position: relative; width: 100%; height: 300px; }
    </style>
</head>
<body>
    <!-- Auth View -->
    <div id="auth-view" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div><h2 class="text-2xl font-bold text-center">Laporan Kartu Stok Fisik Barang</h2><p class="text-center text-gray-600">PT. Glori Mitra Sukses (GMS)</p></div>
            <div id="config-error" class="hidden"></div>
            <div id="auth-forms">
                <form id="login-form"><h3 class="text-xl font-semibold mb-4 text-center">Login</h3><div class="space-y-4"><div><label for="login-email" class="sr-only">Email</label><input type="email" id="login-email" name="email" class="form-input" placeholder="Alamat email" required></div><div><label for="login-password" class="sr-only">Password</label><input type="password" id="login-password" name="password" class="form-input" placeholder="Password" required></div></div><button type="submit" class="w-full mt-6 btn btn-primary">Masuk</button></form>
                <form id="register-form" class="hidden"><h3 class="text-xl font-semibold mb-4 text-center">Daftar Akun Baru</h3><div class="space-y-4"><div><label for="register-email" class="sr-only">Email</label><input type="email" id="register-email" name="email" class="form-input" placeholder="Alamat email" required></div><div><label for="register-password" class="sr-only">Password</label><input type="password" id="register-password" name="password" class="form-input" placeholder="Password (min. 6 karakter)" required></div></div><button type="submit" class="w-full mt-6 btn btn-primary">Daftar</button></form>
                <p id="auth-error" class="text-sm text-center text-red-600 h-4"></p>
                <div class="text-sm text-center text-gray-600"><p>Belum punya akun? <button type="button" id="show-register-btn" class="font-medium text-blue-600 hover:underline">Daftar</button></p><p class="hidden">Sudah punya akun? <button type="button" id="show-login-btn" class="font-medium text-blue-600 hover:underline">Login</button></p></div>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app-view" class="hidden max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex flex-wrap justify-between items-start text-center mb-4">
            <div><h1 class="text-3xl md:text-4xl font-bold text-gray-800">Laporan Kartu Stok Fisik Barang</h1><p class="text-lg text-gray-600">PT. Glori Mitra Sukses (GMS)</p></div>
            <div class="text-right"><p id="user-email-display" class="text-sm text-gray-700"></p><button id="logout-btn" class="btn btn-secondary mt-1">Logout</button></div>
        </header>

        <section class="card p-4 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="item-search-input" class="block text-sm font-medium text-gray-700 mb-1">Cari Nama Barang</label>
                    <div class="relative">
                        <input type="text" id="item-search-input" class="form-input" placeholder="Ketik keyword di sini...">
                        <div id="search-results-container" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg">
                            <!-- Search results will be injected here -->
                        </div>
                    </div>
                </div>
                <div>
                    <label for="main-item-selector" class="block text-sm font-medium text-gray-700 mb-1">Barang Terpilih</label>
                    <select id="main-item-selector" class="form-select bg-gray-100">
                        <option value="">-- Belum ada barang dipilih --</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex-grow">
                        <label for="initial-stock-input" class="block text-sm font-medium text-gray-700 mb-1">Stok Awal</label>
                        <input type="number" id="initial-stock-input" class="form-input" placeholder="0">
                    </div>
                    <div>
                        <button id="save-initial-stock-btn" class="btn btn-primary btn-sm">Simpan</button>
                    </div>
                    <span id="save-status" class="text-sm text-green-600 pt-6"></span>
                </div>
                 <div class="hidden">
                    <button id="manage-items-btn" class="btn btn-secondary w-full">Kelola Daftar Barang</button>
                </div>
            </div>
        </section>

        <main>
            <section id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card p-6"><h3 class="text-md font-medium text-gray-500">Saldo Awal</h3><p id="card-saldo-awal" class="text-3xl font-bold text-gray-800">-</p></div>
                <div class="card p-6"><h3 class="text-md font-medium text-gray-500">Total Masuk</h3><p id="card-total-masuk" class="text-3xl font-bold text-green-600">-</p></div>
                <div class="card p-6"><h3 class="text-md font-medium text-gray-500">Total Keluar</h3><p id="card-total-keluar" class="text-3xl font-bold text-red-600">-</p></div>
                <div class="card p-6 bg-blue-500 text-white"><h3 class="text-md font-medium text-blue-100">Saldo Akhir</h3><p id="card-saldo-akhir" class="text-3xl font-bold">-</p></div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <section class="lg:col-span-1 card p-6">
                    <h2 class="text-xl font-bold mb-4">Tambah Transaksi Stok</h2>
                    <form id="transaction-form" class="space-y-4">
                        <div><label for="form-item-name" class="block text-sm font-medium text-gray-700">Nama Barang</label><select id="form-item-name" name="itemName" class="form-select bg-gray-100"><option value="">-- Pilih dari pencarian --</option></select></div>
                        <div><label for="date" class="block text-sm font-medium text-gray-700">Tanggal</label><input type="date" id="date" name="date" class="form-input" required></div>
                        <div><label for="invoice" class="block text-sm font-medium text-gray-700">Invoice/SJ</label><input type="text" id="invoice" name="invoice" class="form-input" placeholder="Nomor Invoice/Surat Jalan"></div>
                        <div><label for="customerName" class="block text-sm font-medium text-gray-700">Nama Customer</label><input type="text" id="customerName" name="customerName" class="form-input" placeholder="Nama Customer"></div>
                        <div><label for="description" class="block text-sm font-medium text-gray-700">Keterangan</label><input type="text" id="description" name="description" class="form-input" placeholder="Opsional"></div>
                        <div><label for="type" class="block text-sm font-medium text-gray-700">Tipe</label><select id="type" name="type" class="form-select"><option value="masuk">Barang Masuk</option><option value="keluar">Barang Keluar</option></select></div>
                        <div><label for="quantity" class="block text-sm font-medium text-gray-700">Jumlah</label><input type="number" id="quantity" name="quantity" class="form-input" placeholder="0" required min="1"></div>
                        <button type="submit" class="btn btn-primary w-full">Tambah Transaksi</button>
                    </form>
                </section>
                <section class="lg:col-span-2 card p-6">
                    <h2 class="text-xl font-bold mb-4">Grafik Stok</h2><div class="chart-container"><canvas id="stock-chart"></canvas></div>
                </section>
            </div>
            
            <section class="card p-6">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h2 class="text-xl font-bold">Riwayat Transaksi Barang Terpilih</h2>
                    <div class="flex flex-wrap items-center gap-4">
                        <button id="print-history-btn" class="btn btn-secondary">Cetak Riwayat Barang</button>
                        <button id="print-summary-btn" class="btn btn-primary">Cetak Sisa Stok</button>
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="py-3 px-6">Tanggal</th><th scope="col" class="py-3 px-6">Invoice/SJ</th><th scope="col" class="py-3 px-6">Customer</th><th scope="col" class="py-3 px-6">Keterangan</th><th scope="col" class="py-3 px-6">Masuk</th><th scope="col" class="py-3 px-6">Keluar</th><th scope="col" class="py-3 px-6">Saldo</th><th scope="col" class="py-3 px-6">Aksi</th></tr></thead><tbody id="transaction-table-body"></tbody></table></div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="import-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Impor Daftar Barang dari Excel</h3>
            <p class="text-sm text-gray-600 mb-2">Salin 2 kolom (Kolom A: Kategori, Kolom B: Nama Barang) dari file Excel Anda, lalu tempel di bawah ini.</p>
            <p class="text-xs text-gray-500 mb-4">Catatan: Proses ini akan menimpa daftar barang yang ada.</p>
            <form id="import-form">
                <textarea id="import-textarea" rows="10" class="form-input w-full" placeholder="Tempel data dari Excel di sini..."></textarea>
                <div class="flex justify-end items-center gap-4 mt-4">
                    <span id="import-status" class="text-sm"></span>
                    <button type="button" id="cancel-import-btn" class="btn btn-secondary">Batal</button>
                    <button type="submit" class="btn btn-primary">Impor Data</button>
                </div>
            </form>
        </div>
    </div>
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Transaksi</h3>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" name="id">
                <div><label class="block text-sm">Tanggal</label><input type="date" name="date" class="form-input" required></div>
                <div><label class="block text-sm">Nama Barang</label><select name="itemName" class="form-select" disabled></select></div>
                <div><label class="block text-sm">Invoice/SJ</label><input type="text" name="invoice" class="form-input"></div>
                <div><label class="block text-sm">Nama Customer</label><input type="text" name="customerName" class="form-input"></div>
                <div><label class="block text-sm">Keterangan</label><input type="text" name="description" class="form-input"></div>
                <div><label class="block text-sm">Tipe</label><select name="type" class="form-select"><option value="masuk">Barang Masuk</option><option value="keluar">Barang Keluar</option></select></div>
                <div><label class="block text-sm">Jumlah</label><input type="number" name="quantity" class="form-input" required min="1"></div>
                <div class="flex justify-end gap-3 pt-4"><button type="button" id="cancel-edit-btn" class="btn btn-secondary">Batal</button><button type="submit" class="btn btn-primary">Simpan</button></div>
            </form>
        </div>
    </div>
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-medium text-gray-900">Konfirmasi Hapus</h3><p class="mt-2 text-sm text-gray-600">Apakah Anda yakin ingin menghapus transaksi ini?</p><div class="flex justify-end gap-3 pt-4 mt-4"><button type="button" id="cancel-delete-btn" class="btn btn-secondary">Batal</button><button type="button" id="confirm-delete-btn" class="btn btn-danger">Ya, Hapus</button></div>
        </div>
    </div>
</body>
</html>
